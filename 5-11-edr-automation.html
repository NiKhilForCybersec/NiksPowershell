<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>5.11 EDR Automation - PowerShell & Scripting Guide</title>
    <link rel="stylesheet" href="main.css">
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&family=JetBrains+Mono:wght@400;500;600&display=swap" rel="stylesheet">
</head>
<body>
    <div class="layout-wrapper">
        <!-- Sidebar -->
        <aside class="sidebar">
            <div class="sidebar-header">
                <div class="sidebar-logo">
                    <div class="sidebar-logo-icon">ğŸ–¥ï¸</div>
                    <div class="sidebar-logo-text">
                        PowerShell & Scripting
                        <span>Ultimate Guide</span>
                    </div>
                </div>
                <div class="search-container">
                    <span class="search-icon">ğŸ”</span>
                    <input type="text" class="search-input" placeholder="Search documentation...">
                    <span class="search-shortcut">Ctrl+K</span>
                </div>
            </div>
            
                        <nav class="sidebar-nav">
                <!-- Section 1: Scripting Fundamentals -->
                <div class="nav-section" data-section="fundamentals">
                    <div class="nav-section-header">
                        <span class="nav-section-icon">ğŸ“š</span>
                        Scripting Fundamentals
                        <span class="nav-section-toggle">â–¼</span>
                    </div>
                    <div class="nav-section-content">
                        <a href="1-1-scripting-overview.html" class="nav-link"><span class="nav-link-number">1.1</span> Scripting Overview</a>
                        <a href="1-2-choosing-right-tool.html" class="nav-link"><span class="nav-link-number">1.2</span> Choosing the Right Tool</a>
                        <a href="1-3-setting-up-environment.html" class="nav-link"><span class="nav-link-number">1.3</span> Setting Up Environment</a>
                    </div>
                </div>

                <!-- Section 2: PowerShell Deep Dive -->
                <div class="nav-section" data-section="powershell">
                    <div class="nav-section-header">
                        <span class="nav-section-icon">ğŸ”·</span>
                        PowerShell Deep Dive
                        <span class="nav-section-toggle">â–¼</span>
                    </div>
                    <div class="nav-section-content">
                        <a href="2-1-powershell-intro.html" class="nav-link"><span class="nav-link-number">2.1</span> PowerShell Introduction</a>
                        <a href="2-3-pipeline-mastery.html" class="nav-link"><span class="nav-link-number">2.3</span> Pipeline Mastery</a>
                        <a href="2-4-variables-data-types.html" class="nav-link"><span class="nav-link-number">2.4</span> Variables & Data Types</a>
                        <a href="2-5-working-with-objects.html" class="nav-link"><span class="nav-link-number">2.5</span> Working with Objects</a>
                        <a href="2-6-control-structures.html" class="nav-link"><span class="nav-link-number">2.6</span> Control Structures</a>
                        <a href="2-7-functions.html" class="nav-link"><span class="nav-link-number">2.7</span> Functions</a>
                        <a href="2-8-files.html" class="nav-link"><span class="nav-link-number">2.8</span> Working with Files</a>
                        <a href="2-9-wmi-cim.html" class="nav-link"><span class="nav-link-number">2.9</span> WMI & CIM</a>
                        <a href="2-10-registry.html" class="nav-link"><span class="nav-link-number">2.10</span> Registry Operations</a>
                        <a href="2-15-eventlog-analysis.html" class="nav-link"><span class="nav-link-number">2.15</span> Event Log Analysis</a>
                        <a href="2-16-active-directory.html" class="nav-link"><span class="nav-link-number">2.16</span> Active Directory</a>
                        <a href="2-17-networking-commands.html" class="nav-link"><span class="nav-link-number">2.17</span> Networking Commands</a>
                        <a href="2-18-web-requests.html" class="nav-link"><span class="nav-link-number">2.18</span> Web Requests & APIs</a>
                        <a href="2-19-remoting-jobs.html" class="nav-link"><span class="nav-link-number">2.19</span> Remoting & Jobs</a>
                        <a href="2-20-error-handling.html" class="nav-link"><span class="nav-link-number">2.20</span> Error Handling</a>
                        <a href="2-21-modules-profiles.html" class="nav-link"><span class="nav-link-number">2.21</span> Modules & Profiles</a>
                    </div>
                </div>

                <!-- Section 3: Bash Scripting -->
                <div class="nav-section" data-section="bash">
                    <div class="nav-section-header">
                        <span class="nav-section-icon">ğŸ§</span>
                        Bash Scripting
                        <span class="nav-section-toggle">â–¼</span>
                    </div>
                    <div class="nav-section-content">
                        <a href="3-1-bash-intro.html" class="nav-link"><span class="nav-link-number">3.1</span> Bash Introduction</a>
                        <a href="3-3-bash-variables.html" class="nav-link"><span class="nav-link-number">3.3</span> Variables & Data Types</a>
                        <a href="3-4-control-structures.html" class="nav-link"><span class="nav-link-number">3.4</span> Control Structures</a>
                        <a href="3-5-bash-functions.html" class="nav-link"><span class="nav-link-number">3.5</span> Functions & Scripts</a>
                        <a href="3-6-file-io.html" class="nav-link"><span class="nav-link-number">3.6</span> File I/O</a>
                        <a href="3-7-process-management.html" class="nav-link"><span class="nav-link-number">3.7</span> Process Management</a>
                        <a href="3-8-system-admin.html" class="nav-link"><span class="nav-link-number">3.8</span> System Administration</a>
                        <a href="3-9-regex.html" class="nav-link"><span class="nav-link-number">3.9</span> Regular Expressions</a>
                        <a href="3-10-text-processing.html" class="nav-link"><span class="nav-link-number">3.10</span> Text Processing</a>
                        <a href="3-12-bash-networking.html" class="nav-link"><span class="nav-link-number">3.12</span> Bash Networking</a>
                    </div>
                </div>

                <!-- Section 4: Batch/CMD Scripting -->
                <div class="nav-section collapsed" data-section="batch">
                    <div class="nav-section-header">
                        <span class="nav-section-icon">ğŸ“¦</span>
                        Batch/CMD Scripting
                        <span class="nav-section-toggle">â–¼</span>
                    </div>
                    <div class="nav-section-content">
                        <a href="4-1-batch-intro.html" class="nav-link"><span class="nav-link-number">4.1</span> Batch Introduction</a>
                    </div>
                </div>

                <!-- Section 5: Security Automation -->
                <div class="nav-section" data-section="security">
                    <div class="nav-section-header">
                        <span class="nav-section-icon">ğŸ›¡ï¸</span>
                        Security Automation
                        <span class="nav-section-toggle">â–¼</span>
                    </div>
                    <div class="nav-section-content">
                        <a href="5-6-incident-response-scripts.html" class="nav-link"><span class="nav-link-number">5.6</span> Incident Response</a>
                        <a href="5-7-threat-hunting-scripts.html" class="nav-link"><span class="nav-link-number">5.7</span> Threat Hunting</a>
                        <a href="5-8-vulnerability-scanning.html" class="nav-link"><span class="nav-link-number">5.8</span> Vulnerability Scanning</a>
                        <a href="5-9-forensics-scripts.html" class="nav-link"><span class="nav-link-number">5.9</span> Digital Forensics</a>
                        <a href="5-10-siem-integration.html" class="nav-link"><span class="nav-link-number">5.10</span> SIEM Integration</a>
                        <a href="5-11-edr-automation.html" class="nav-link"><span class="nav-link-number">5.11</span> EDR Automation</a>
                        <a href="5-12-compliance-automation.html" class="nav-link"><span class="nav-link-number">5.12</span> Compliance Automation</a>
                        <a href="5-13-log-analysis.html" class="nav-link"><span class="nav-link-number">5.13</span> Log Analysis</a>
                        <a href="5-14-malware-analysis.html" class="nav-link"><span class="nav-link-number">5.14</span> Malware Analysis</a>
                    </div>
                </div>

                <!-- Section 6: Cross-Platform Integration -->
                <div class="nav-section collapsed" data-section="integration">
                    <div class="nav-section-header">
                        <span class="nav-section-icon">ğŸ”—</span>
                        Cross-Platform Integration
                        <span class="nav-section-toggle">â–¼</span>
                    </div>
                    <div class="nav-section-content">
                        <a href="6-1-python-integration.html" class="nav-link"><span class="nav-link-number">6.1</span> Python Integration</a>
                    </div>
                </div>

                <!-- Section 7: Cloud & DevOps -->
                <div class="nav-section collapsed" data-section="cloud">
                    <div class="nav-section-header">
                        <span class="nav-section-icon">â˜ï¸</span>
                        Cloud & DevOps
                        <span class="nav-section-toggle">â–¼</span>
                    </div>
                    <div class="nav-section-content">
                        <a href="7-1-azure-automation.html" class="nav-link"><span class="nav-link-number">7.1</span> Azure Automation</a>
                    </div>
                </div>

                <!-- Section 8: Real-World Projects -->
                <div class="nav-section collapsed" data-section="projects">
                    <div class="nav-section-header">
                        <span class="nav-section-icon">ğŸš€</span>
                        Real-World Projects
                        <span class="nav-section-toggle">â–¼</span>
                    </div>
                    <div class="nav-section-content">
                        <a href="8-1-security-dashboard.html" class="nav-link"><span class="nav-link-number">8.1</span> Security Dashboard</a>
                        <a href="8-2-log-aggregator.html" class="nav-link"><span class="nav-link-number">8.2</span> Log Aggregator</a>
                        <a href="8-3-asset-inventory.html" class="nav-link"><span class="nav-link-number">8.3</span> Asset Inventory</a>
                    </div>
                </div>

                <!-- Section 9: Troubleshooting -->
                <div class="nav-section collapsed" data-section="troubleshooting">
                    <div class="nav-section-header">
                        <span class="nav-section-icon">ğŸ”§</span>
                        Troubleshooting
                        <span class="nav-section-toggle">â–¼</span>
                    </div>
                    <div class="nav-section-content">
                        <a href="9-1-common-errors.html" class="nav-link"><span class="nav-link-number">9.1</span> Common Errors</a>
                        <a href="9-2-debugging-techniques.html" class="nav-link"><span class="nav-link-number">9.2</span> Debugging Techniques</a>
                        <a href="9-3-performance-issues.html" class="nav-link"><span class="nav-link-number">9.3</span> Performance Issues</a>
                    </div>
                </div>

                <!-- Section 10: Reference -->
                <div class="nav-section collapsed" data-section="reference">
                    <div class="nav-section-header">
                        <span class="nav-section-icon">ğŸ“‹</span>
                        Best Practices & Reference
                        <span class="nav-section-toggle">â–¼</span>
                    </div>
                    <div class="nav-section-content">
                        <a href="10-5-cheat-sheets.html" class="nav-link"><span class="nav-link-number">10.5</span> Cheat Sheets</a>
                        <a href="10-6-interview-preparation.html" class="nav-link"><span class="nav-link-number">10.6</span> Interview Preparation</a>
                        <a href="10-7-log-paths-reference.html" class="nav-link"><span class="nav-link-number">10.7</span> Log Paths Reference</a>
                    </div>
                </div>
            </nav>

        </aside>

        <!-- Main Content Area -->
        <main class="main-content">
            <div class="content-wrapper">
                <!-- Breadcrumb -->
                <nav class="breadcrumb">
                    <a href="index.html">Home</a>
                    <span class="breadcrumb-separator">â€º</span>
                    <a href="index.html#security">Security Automation</a>
                    <span class="breadcrumb-separator">â€º</span>
                    <span>EDR Automation</span>
                </nav>

                <!-- Page Title -->
                <h1>5.11 EDR Automation</h1>

                <!-- What You'll Learn Box -->
                <div class="info-box overview-box">
                    <div class="info-box-header">
                        <div class="info-box-icon">ğŸ“–</div>
                        <div class="info-box-title">What You'll Learn</div>
                    </div>
                    <ul>
                        <li>Automate endpoint detection and response (EDR) workflows</li>
                        <li>Script Microsoft Defender for Endpoint (MDE) API integration</li>
                        <li>Create Cortex XDR automation with XSOAR playbooks</li>
                        <li>Build automated threat response and containment scripts</li>
                        <li>Integrate EDR telemetry with SIEM platforms</li>
                    </ul>
                </div>

                <!-- Introduction -->
                <h2>Automating EDR Operations</h2>
                <p>
                    Modern EDR platforms provide powerful APIs that enable security teams to automate 
                    detection, investigation, and response workflows. By scripting EDR operations, 
                    you can reduce mean time to respond (MTTR), ensure consistent investigation 
                    procedures, and scale your security operations.
                </p>

                <!-- Memory Aid -->
                <div class="info-box memory-box">
                    <div class="info-box-header">
                        <div class="info-box-icon">ğŸ§ </div>
                        <div class="info-box-title">Memory Aid: EDR Automation Layers</div>
                    </div>
                    <ul>
                        <li><strong>D</strong>etect â†’ Query EDR for alerts, indicators, suspicious activity</li>
                        <li><strong>I</strong>nvestigate â†’ Enrich alerts with context, correlate data, timeline events</li>
                        <li><strong>R</strong>espond â†’ Isolate hosts, kill processes, quarantine files</li>
                        <li><strong>R</strong>eport â†’ Document actions, update tickets, notify stakeholders</li>
                    </ul>
                    <p style="margin-top: 1rem; color: var(--text-muted);">
                        ğŸ¯ <em>Remember <strong>D.I.R.R.</strong> â€” Detect, Investigate, Respond, Report. 
                        Automate each layer for maximum efficiency!</em>
                    </p>
                </div>

                <!-- EDR Landscape -->
                <h2>EDR Platform Comparison</h2>

                <div class="table-container">
                    <table>
                        <thead>
                            <tr>
                                <th>Feature</th>
                                <th>Microsoft Defender for Endpoint</th>
                                <th>Cortex XDR</th>
                                <th>CrowdStrike Falcon</th>
                            </tr>
                        </thead>
                        <tbody>
                            <tr>
                                <td><strong>API Type</strong></td>
                                <td>REST (Microsoft Graph)</td>
                                <td>REST</td>
                                <td>REST (OAuth2)</td>
                            </tr>
                            <tr>
                                <td><strong>Auth Method</strong></td>
                                <td>Azure AD / App Registration</td>
                                <td>API Key</td>
                                <td>OAuth2 Client Credentials</td>
                            </tr>
                            <tr>
                                <td><strong>SOAR Integration</strong></td>
                                <td>Microsoft Sentinel, Logic Apps</td>
                                <td>XSOAR (native)</td>
                                <td>Falcon Fusion, 3rd party</td>
                            </tr>
                            <tr>
                                <td><strong>PowerShell Module</strong></td>
                                <td>Microsoft.Graph.Security</td>
                                <td>Custom/REST</td>
                                <td>PSFalcon</td>
                            </tr>
                            <tr>
                                <td><strong>Live Response</strong></td>
                                <td>Yes (Live Response API)</td>
                                <td>Yes (Live Terminal)</td>
                                <td>Yes (Real Time Response)</td>
                            </tr>
                            <tr>
                                <td><strong>Isolation</strong></td>
                                <td>Network isolation via API</td>
                                <td>Isolate endpoint action</td>
                                <td>Network containment</td>
                            </tr>
                        </tbody>
                    </table>
                </div>

                <!-- MDE Section -->
                <h2>Microsoft Defender for Endpoint Automation</h2>

                <h3>Setting Up MDE API Access</h3>

                <div class="ascii-diagram">
                    <div class="ascii-diagram-title">ğŸ“Š MDE API Authentication Flow</div>
<pre>
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                    MDE API AUTHENTICATION FLOW                               â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜

â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”     â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”     â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚   Azure AD   â”‚     â”‚  App Registration â”‚     â”‚   MDE API           â”‚
â”‚   Tenant     â”‚     â”‚                  â”‚     â”‚   (Security Center) â”‚
â””â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”˜     â””â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜     â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
       â”‚                      â”‚                          â”‚
       â”‚  1. Register App     â”‚                          â”‚
       â”‚ â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â–ºâ”‚                          â”‚
       â”‚                      â”‚                          â”‚
       â”‚  2. Configure        â”‚                          â”‚
       â”‚     Permissions:     â”‚                          â”‚
       â”‚     â€¢ Machine.Read   â”‚                          â”‚
       â”‚     â€¢ Alert.Read     â”‚                          â”‚
       â”‚     â€¢ Alert.ReadWriteâ”‚                          â”‚
       â”‚ â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â–ºâ”‚                          â”‚
       â”‚                      â”‚                          â”‚
       â”‚  3. Grant Admin      â”‚                          â”‚
       â”‚     Consent          â”‚                          â”‚
       â”‚ â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â–ºâ”‚                          â”‚
       â”‚                      â”‚                          â”‚
       â”‚                      â”‚  4. Request Token        â”‚
       â”‚                      â”‚  (Client Credentials)    â”‚
       â”‚                      â”‚ â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â–ºâ”‚
       â”‚                      â”‚                          â”‚
       â”‚                      â”‚  5. Bearer Token         â”‚
       â”‚                      â”‚ â—„â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”‚
       â”‚                      â”‚                          â”‚
       â”‚                      â”‚  6. API Calls with Token â”‚
       â”‚                      â”‚ â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â–ºâ”‚
       â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜

Required API Permissions (Application):
â”œâ”€â”€ Machine.Read.All          - Read machine information
â”œâ”€â”€ Machine.ReadWrite.All     - Take actions on machines
â”œâ”€â”€ Alert.Read.All            - Read alerts
â”œâ”€â”€ Alert.ReadWrite.All       - Update alert status
â”œâ”€â”€ AdvancedQuery.Read.All    - Run Advanced Hunting queries
â””â”€â”€ Machine.Isolate           - Network isolate machines
</pre>
                </div>

                <div class="code-container">
                    <div class="code-header">
                        <span class="code-language powershell">
                            <span class="code-language-icon">ğŸ”·</span>
                            PowerShell - MDE API Authentication
                        </span>
                        <button class="code-copy-btn"><span>ğŸ“‹</span> Copy</button>
                    </div>
                    <div class="code-block">
<pre><code><span class="token-keyword">function</span> <span class="token-function">Get-MdeAccessToken</span> {
    <span class="token-comment">&lt;#
    .SYNOPSIS
        Obtains an access token for Microsoft Defender for Endpoint API.
    .PARAMETER TenantId
        Azure AD Tenant ID
    .PARAMETER ClientId
        App Registration Client ID
    .PARAMETER ClientSecret
        App Registration Client Secret
    #&gt;</span>
    [CmdletBinding()]
    <span class="token-keyword">param</span>(
        [Parameter(Mandatory)]
        [string]<span class="token-variable">$TenantId</span>,
        
        [Parameter(Mandatory)]
        [string]<span class="token-variable">$ClientId</span>,
        
        [Parameter(Mandatory)]
        [string]<span class="token-variable">$ClientSecret</span>
    )
    
    <span class="token-variable">$TokenEndpoint</span> = <span class="token-string">"https://login.microsoftonline.com/$TenantId/oauth2/v2.0/token"</span>
    
    <span class="token-variable">$Body</span> = @{
        client_id     = <span class="token-variable">$ClientId</span>
        client_secret = <span class="token-variable">$ClientSecret</span>
        scope         = <span class="token-string">"https://api.securitycenter.microsoft.com/.default"</span>
        grant_type    = <span class="token-string">"client_credentials"</span>
    }
    
    <span class="token-keyword">try</span> {
        <span class="token-variable">$Response</span> = <span class="token-cmdlet">Invoke-RestMethod</span> <span class="token-parameter">-Uri</span> <span class="token-variable">$TokenEndpoint</span> `
            <span class="token-parameter">-Method</span> Post `
            <span class="token-parameter">-Body</span> <span class="token-variable">$Body</span> `
            <span class="token-parameter">-ContentType</span> <span class="token-string">"application/x-www-form-urlencoded"</span>
        
        <span class="token-keyword">return</span> <span class="token-variable">$Response</span>.access_token
    }
    <span class="token-keyword">catch</span> {
        <span class="token-cmdlet">Write-Error</span> <span class="token-string">"Failed to obtain access token: $_"</span>
        <span class="token-keyword">return</span> <span class="token-variable">$null</span>
    }
}

<span class="token-comment"># Usage</span>
<span class="token-variable">$Token</span> = Get-MdeAccessToken `
    <span class="token-parameter">-TenantId</span> <span class="token-string">"your-tenant-id"</span> `
    <span class="token-parameter">-ClientId</span> <span class="token-string">"your-client-id"</span> `
    <span class="token-parameter">-ClientSecret</span> <span class="token-string">"your-client-secret"</span>

<span class="token-variable">$Headers</span> = @{
    <span class="token-string">"Authorization"</span> = <span class="token-string">"Bearer $Token"</span>
    <span class="token-string">"Content-Type"</span>  = <span class="token-string">"application/json"</span>
}</code></pre>
                    </div>
                </div>

                <h3>Querying MDE Alerts</h3>

                <div class="code-container">
                    <div class="code-header">
                        <span class="code-language powershell">
                            <span class="code-language-icon">ğŸ”·</span>
                            PowerShell - Query MDE Alerts
                        </span>
                        <button class="code-copy-btn"><span>ğŸ“‹</span> Copy</button>
                    </div>
                    <div class="code-block">
<pre><code><span class="token-keyword">function</span> <span class="token-function">Get-MdeAlerts</span> {
    <span class="token-comment">&lt;#
    .SYNOPSIS
        Retrieves alerts from Microsoft Defender for Endpoint.
    .PARAMETER Severity
        Filter by severity: High, Medium, Low, Informational
    .PARAMETER Status
        Filter by status: New, InProgress, Resolved
    .PARAMETER HoursBack
        Get alerts from the last N hours
    #&gt;</span>
    [CmdletBinding()]
    <span class="token-keyword">param</span>(
        [Parameter(Mandatory)]
        [string]<span class="token-variable">$AccessToken</span>,
        
        [ValidateSet(<span class="token-string">'High'</span>, <span class="token-string">'Medium'</span>, <span class="token-string">'Low'</span>, <span class="token-string">'Informational'</span>)]
        [string]<span class="token-variable">$Severity</span>,
        
        [ValidateSet(<span class="token-string">'New'</span>, <span class="token-string">'InProgress'</span>, <span class="token-string">'Resolved'</span>)]
        [string]<span class="token-variable">$Status</span> = <span class="token-string">'New'</span>,
        
        [int]<span class="token-variable">$HoursBack</span> = 24
    )
    
    <span class="token-variable">$BaseUri</span> = <span class="token-string">"https://api.securitycenter.microsoft.com/api/alerts"</span>
    
    <span class="token-comment"># Build OData filter</span>
    <span class="token-variable">$StartTime</span> = (Get-Date).AddHours(-<span class="token-variable">$HoursBack</span>).ToUniversalTime().ToString(<span class="token-string">"yyyy-MM-ddTHH:mm:ssZ"</span>)
    <span class="token-variable">$Filter</span> = <span class="token-string">"alertCreationTime ge $StartTime and status eq '$Status'"</span>
    
    <span class="token-keyword">if</span> (<span class="token-variable">$Severity</span>) {
        <span class="token-variable">$Filter</span> += <span class="token-string">" and severity eq '$Severity'"</span>
    }
    
    <span class="token-variable">$Uri</span> = <span class="token-string">"${BaseUri}?`$filter=$Filter"</span>
    
    <span class="token-variable">$Headers</span> = @{
        <span class="token-string">"Authorization"</span> = <span class="token-string">"Bearer $AccessToken"</span>
    }
    
    <span class="token-keyword">try</span> {
        <span class="token-variable">$Response</span> = <span class="token-cmdlet">Invoke-RestMethod</span> <span class="token-parameter">-Uri</span> <span class="token-variable">$Uri</span> <span class="token-parameter">-Headers</span> <span class="token-variable">$Headers</span> <span class="token-parameter">-Method</span> Get
        
        <span class="token-variable">$Response</span>.value | <span class="token-cmdlet">Select-Object</span> `
            id,
            title,
            severity,
            status,
            alertCreationTime,
            machineId,
            @{N=<span class="token-string">'MachineName'</span>;E={<span class="token-variable">$_</span>.computerDnsName}},
            category,
            description
    }
    <span class="token-keyword">catch</span> {
        <span class="token-cmdlet">Write-Error</span> <span class="token-string">"Failed to retrieve alerts: $_"</span>
    }
}

<span class="token-comment"># Get high severity alerts from last 24 hours</span>
<span class="token-variable">$Alerts</span> = Get-MdeAlerts <span class="token-parameter">-AccessToken</span> <span class="token-variable">$Token</span> <span class="token-parameter">-Severity</span> High <span class="token-parameter">-HoursBack</span> <span class="token-number">24</span>
<span class="token-variable">$Alerts</span> | <span class="token-cmdlet">Format-Table</span> <span class="token-parameter">-AutoSize</span></code></pre>
                    </div>
                </div>

                <h3>Automated Threat Response: Isolate Machine</h3>

                <div class="code-container">
                    <div class="code-header">
                        <span class="code-language powershell">
                            <span class="code-language-icon">ğŸ”·</span>
                            PowerShell - Isolate Compromised Endpoint
                        </span>
                        <button class="code-copy-btn"><span>ğŸ“‹</span> Copy</button>
                    </div>
                    <div class="code-block">
<pre><code><span class="token-keyword">function</span> <span class="token-function">Invoke-MdeIsolateMachine</span> {
    <span class="token-comment">&lt;#
    .SYNOPSIS
        Isolates a machine from the network via MDE.
    .PARAMETER MachineId
        The MDE Machine ID to isolate
    .PARAMETER IsolationType
        Full or Selective isolation
    .PARAMETER Comment
        Reason for isolation (for audit trail)
    #&gt;</span>
    [CmdletBinding(SupportsShouldProcess)]
    <span class="token-keyword">param</span>(
        [Parameter(Mandatory)]
        [string]<span class="token-variable">$AccessToken</span>,
        
        [Parameter(Mandatory)]
        [string]<span class="token-variable">$MachineId</span>,
        
        [ValidateSet(<span class="token-string">'Full'</span>, <span class="token-string">'Selective'</span>)]
        [string]<span class="token-variable">$IsolationType</span> = <span class="token-string">'Full'</span>,
        
        [Parameter(Mandatory)]
        [string]<span class="token-variable">$Comment</span>
    )
    
    <span class="token-variable">$Uri</span> = <span class="token-string">"https://api.securitycenter.microsoft.com/api/machines/$MachineId/isolate"</span>
    
    <span class="token-variable">$Body</span> = @{
        Comment = <span class="token-variable">$Comment</span>
        IsolationType = <span class="token-variable">$IsolationType</span>
    } | <span class="token-cmdlet">ConvertTo-Json</span>
    
    <span class="token-variable">$Headers</span> = @{
        <span class="token-string">"Authorization"</span> = <span class="token-string">"Bearer $AccessToken"</span>
        <span class="token-string">"Content-Type"</span>  = <span class="token-string">"application/json"</span>
    }
    
    <span class="token-keyword">if</span> (<span class="token-variable">$PSCmdlet</span>.ShouldProcess(<span class="token-variable">$MachineId</span>, <span class="token-string">"Isolate machine"</span>)) {
        <span class="token-keyword">try</span> {
            <span class="token-variable">$Response</span> = <span class="token-cmdlet">Invoke-RestMethod</span> <span class="token-parameter">-Uri</span> <span class="token-variable">$Uri</span> `
                <span class="token-parameter">-Headers</span> <span class="token-variable">$Headers</span> `
                <span class="token-parameter">-Method</span> Post `
                <span class="token-parameter">-Body</span> <span class="token-variable">$Body</span>
            
            <span class="token-cmdlet">Write-Host</span> <span class="token-string">"[+] Machine isolation initiated"</span> <span class="token-parameter">-ForegroundColor</span> Green
            <span class="token-cmdlet">Write-Host</span> <span class="token-string">"    Action ID: $($Response.id)"</span>
            <span class="token-cmdlet">Write-Host</span> <span class="token-string">"    Status: $($Response.status)"</span>
            
            <span class="token-keyword">return</span> <span class="token-variable">$Response</span>
        }
        <span class="token-keyword">catch</span> {
            <span class="token-cmdlet">Write-Error</span> <span class="token-string">"Failed to isolate machine: $_"</span>
        }
    }
}

<span class="token-comment"># Isolate a compromised machine</span>
Invoke-MdeIsolateMachine `
    <span class="token-parameter">-AccessToken</span> <span class="token-variable">$Token</span> `
    <span class="token-parameter">-MachineId</span> <span class="token-string">"machine-id-here"</span> `
    <span class="token-parameter">-IsolationType</span> Full `
    <span class="token-parameter">-Comment</span> <span class="token-string">"IR-2024-001: Ransomware detected, isolating for investigation"</span></code></pre>
                    </div>
                </div>

                <!-- Cortex XDR Section -->
                <h2>Cortex XDR Automation</h2>

                <h3>Cortex XDR API Authentication</h3>

                <div class="code-container">
                    <div class="code-header">
                        <span class="code-language powershell">
                            <span class="code-language-icon">ğŸ”·</span>
                            PowerShell - Cortex XDR API Setup
                        </span>
                        <button class="code-copy-btn"><span>ğŸ“‹</span> Copy</button>
                    </div>
                    <div class="code-block">
<pre><code><span class="token-keyword">function</span> <span class="token-function">Invoke-CortexXdrApi</span> {
    <span class="token-comment">&lt;#
    .SYNOPSIS
        Invokes Cortex XDR API endpoints.
    .DESCRIPTION
        Handles authentication headers and API calls for Cortex XDR.
        Supports both standard and advanced API keys.
    #&gt;</span>
    [CmdletBinding()]
    <span class="token-keyword">param</span>(
        [Parameter(Mandatory)]
        [string]<span class="token-variable">$ApiKey</span>,
        
        [Parameter(Mandatory)]
        [string]<span class="token-variable">$ApiKeyId</span>,
        
        [Parameter(Mandatory)]
        [string]<span class="token-variable">$Fqdn</span>,  <span class="token-comment"># e.g., "api-example.xdr.us.paloaltonetworks.com"</span>
        
        [Parameter(Mandatory)]
        [string]<span class="token-variable">$Endpoint</span>,  <span class="token-comment"># e.g., "/public_api/v1/alerts/get_alerts"</span>
        
        [hashtable]<span class="token-variable">$Body</span> = @{}
    )
    
    <span class="token-comment"># Generate nonce and timestamp for authentication</span>
    <span class="token-variable">$Nonce</span> = [guid]::NewGuid().ToString()
    <span class="token-variable">$Timestamp</span> = [DateTimeOffset]::UtcNow.ToUnixTimeMilliseconds()
    
    <span class="token-comment"># Create authentication string</span>
    <span class="token-variable">$AuthString</span> = <span class="token-string">"$ApiKey$Nonce$Timestamp"</span>
    
    <span class="token-comment"># Generate authorization header</span>
    <span class="token-variable">$Headers</span> = @{
        <span class="token-string">"x-xdr-auth-id"</span>    = <span class="token-variable">$ApiKeyId</span>
        <span class="token-string">"x-xdr-nonce"</span>      = <span class="token-variable">$Nonce</span>
        <span class="token-string">"x-xdr-timestamp"</span>  = <span class="token-variable">$Timestamp</span>
        <span class="token-string">"Authorization"</span>    = <span class="token-variable">$ApiKey</span>
        <span class="token-string">"Content-Type"</span>     = <span class="token-string">"application/json"</span>
    }
    
    <span class="token-variable">$Uri</span> = <span class="token-string">"https://$Fqdn$Endpoint"</span>
    
    <span class="token-keyword">try</span> {
        <span class="token-variable">$Response</span> = <span class="token-cmdlet">Invoke-RestMethod</span> <span class="token-parameter">-Uri</span> <span class="token-variable">$Uri</span> `
            <span class="token-parameter">-Headers</span> <span class="token-variable">$Headers</span> `
            <span class="token-parameter">-Method</span> Post `
            <span class="token-parameter">-Body</span> (<span class="token-variable">$Body</span> | <span class="token-cmdlet">ConvertTo-Json</span> <span class="token-parameter">-Depth</span> <span class="token-number">10</span>)
        
        <span class="token-keyword">return</span> <span class="token-variable">$Response</span>
    }
    <span class="token-keyword">catch</span> {
        <span class="token-cmdlet">Write-Error</span> <span class="token-string">"Cortex XDR API call failed: $_"</span>
    }
}

<span class="token-comment"># Get alerts from Cortex XDR</span>
<span class="token-variable">$Alerts</span> = Invoke-CortexXdrApi `
    <span class="token-parameter">-ApiKey</span> <span class="token-variable">$XdrApiKey</span> `
    <span class="token-parameter">-ApiKeyId</span> <span class="token-variable">$XdrApiKeyId</span> `
    <span class="token-parameter">-Fqdn</span> <span class="token-string">"api-example.xdr.us.paloaltonetworks.com"</span> `
    <span class="token-parameter">-Endpoint</span> <span class="token-string">"/public_api/v1/alerts/get_alerts"</span> `
    <span class="token-parameter">-Body</span> @{
        request_data = @{
            filters = @(
                @{
                    field = <span class="token-string">"severity"</span>
                    operator = <span class="token-string">"in"</span>
                    value = @(<span class="token-string">"high"</span>, <span class="token-string">"critical"</span>)
                }
            )
            sort = @{
                field = <span class="token-string">"creation_time"</span>
                keyword = <span class="token-string">"desc"</span>
            }
        }
    }</code></pre>
                    </div>
                </div>

                <!-- Automated Response Workflow -->
                <h2>Complete Automated Response Workflow</h2>

                <div class="code-container">
                    <div class="code-header">
                        <span class="code-language powershell">
                            <span class="code-language-icon">ğŸ”·</span>
                            PowerShell - Automated Threat Response Workflow
                        </span>
                        <button class="code-copy-btn"><span>ğŸ“‹</span> Copy</button>
                    </div>
                    <div class="code-block">
<pre><code><span class="token-keyword">function</span> <span class="token-function">Invoke-AutomatedThreatResponse</span> {
    <span class="token-comment">&lt;#
    .SYNOPSIS
        Automated threat response workflow for EDR alerts.
    .DESCRIPTION
        1. Query EDR for new high-severity alerts
        2. Enrich with threat intelligence
        3. Isolate affected endpoints
        4. Collect forensic artifacts
        5. Create incident ticket
        6. Notify SOC team
    #&gt;</span>
    [CmdletBinding()]
    <span class="token-keyword">param</span>(
        [Parameter(Mandatory)]
        [hashtable]<span class="token-variable">$MdeCredentials</span>,
        
        [string]<span class="token-variable">$SlackWebhook</span>,
        
        [switch]<span class="token-variable">$AutoIsolate</span>
    )
    
    <span class="token-cmdlet">Write-Host</span> <span class="token-string">"[*] Starting automated threat response workflow..."</span> <span class="token-parameter">-ForegroundColor</span> Cyan
    
    <span class="token-comment"># Step 1: Get access token</span>
    <span class="token-variable">$Token</span> = Get-MdeAccessToken @MdeCredentials
    
    <span class="token-keyword">if</span> (-not <span class="token-variable">$Token</span>) {
        <span class="token-cmdlet">Write-Error</span> <span class="token-string">"Failed to authenticate"</span>
        <span class="token-keyword">return</span>
    }
    
    <span class="token-comment"># Step 2: Query for new high-severity alerts</span>
    <span class="token-cmdlet">Write-Host</span> <span class="token-string">"[*] Querying for high-severity alerts..."</span>
    <span class="token-variable">$Alerts</span> = Get-MdeAlerts <span class="token-parameter">-AccessToken</span> <span class="token-variable">$Token</span> <span class="token-parameter">-Severity</span> High <span class="token-parameter">-Status</span> New
    
    <span class="token-keyword">if</span> (-not <span class="token-variable">$Alerts</span>) {
        <span class="token-cmdlet">Write-Host</span> <span class="token-string">"[+] No new high-severity alerts found"</span> <span class="token-parameter">-ForegroundColor</span> Green
        <span class="token-keyword">return</span>
    }
    
    <span class="token-cmdlet">Write-Host</span> <span class="token-string">"[!] Found $($Alerts.Count) high-severity alerts"</span> <span class="token-parameter">-ForegroundColor</span> Yellow
    
    <span class="token-keyword">foreach</span> (<span class="token-variable">$Alert</span> <span class="token-keyword">in</span> <span class="token-variable">$Alerts</span>) {
        <span class="token-cmdlet">Write-Host</span> <span class="token-string">"`n[*] Processing: $($Alert.title)"</span>
        <span class="token-cmdlet">Write-Host</span> <span class="token-string">"    Machine: $($Alert.MachineName)"</span>
        <span class="token-cmdlet">Write-Host</span> <span class="token-string">"    Category: $($Alert.category)"</span>
        
        <span class="token-comment"># Step 3: Check if auto-isolation is enabled for critical categories</span>
        <span class="token-variable">$CriticalCategories</span> = @(<span class="token-string">'Ransomware'</span>, <span class="token-string">'Malware'</span>, <span class="token-string">'CommandAndControl'</span>)
        
        <span class="token-keyword">if</span> (<span class="token-variable">$AutoIsolate</span> <span class="token-operator">-and</span> <span class="token-variable">$Alert</span>.category <span class="token-operator">-in</span> <span class="token-variable">$CriticalCategories</span>) {
            <span class="token-cmdlet">Write-Host</span> <span class="token-string">"    [!] Critical threat - initiating isolation..."</span> <span class="token-parameter">-ForegroundColor</span> Red
            
            Invoke-MdeIsolateMachine `
                <span class="token-parameter">-AccessToken</span> <span class="token-variable">$Token</span> `
                <span class="token-parameter">-MachineId</span> <span class="token-variable">$Alert</span>.machineId `
                <span class="token-parameter">-Comment</span> <span class="token-string">"Auto-isolation: $($Alert.title)"</span>
        }
        
        <span class="token-comment"># Step 4: Send Slack notification</span>
        <span class="token-keyword">if</span> (<span class="token-variable">$SlackWebhook</span>) {
            <span class="token-variable">$SlackMessage</span> = @{
                text = <span class="token-string">"ğŸš¨ *MDE Alert: $($Alert.title)*`nMachine: $($Alert.MachineName)`nSeverity: $($Alert.severity)`nCategory: $($Alert.category)"</span>
            } | <span class="token-cmdlet">ConvertTo-Json</span>
            
            <span class="token-cmdlet">Invoke-RestMethod</span> <span class="token-parameter">-Uri</span> <span class="token-variable">$SlackWebhook</span> <span class="token-parameter">-Method</span> Post <span class="token-parameter">-Body</span> <span class="token-variable">$SlackMessage</span> <span class="token-parameter">-ContentType</span> <span class="token-string">"application/json"</span>
        }
        
        <span class="token-comment"># Step 5: Update alert status to InProgress</span>
        <span class="token-variable">$UpdateUri</span> = <span class="token-string">"https://api.securitycenter.microsoft.com/api/alerts/$($Alert.id)"</span>
        <span class="token-variable">$UpdateBody</span> = @{
            status = <span class="token-string">"InProgress"</span>
            assignedTo = <span class="token-string">"SOC-Automation"</span>
            comment = <span class="token-string">"Auto-processed by threat response automation"</span>
        } | <span class="token-cmdlet">ConvertTo-Json</span>
        
        <span class="token-cmdlet">Invoke-RestMethod</span> <span class="token-parameter">-Uri</span> <span class="token-variable">$UpdateUri</span> `
            <span class="token-parameter">-Headers</span> @{<span class="token-string">"Authorization"</span> = <span class="token-string">"Bearer $Token"</span>; <span class="token-string">"Content-Type"</span> = <span class="token-string">"application/json"</span>} `
            <span class="token-parameter">-Method</span> Patch `
            <span class="token-parameter">-Body</span> <span class="token-variable">$UpdateBody</span>
        
        <span class="token-cmdlet">Write-Host</span> <span class="token-string">"    [+] Alert marked as InProgress"</span> <span class="token-parameter">-ForegroundColor</span> Green
    }
    
    <span class="token-cmdlet">Write-Host</span> <span class="token-string">"`n[âœ“] Threat response workflow complete"</span> <span class="token-parameter">-ForegroundColor</span> Green
}</code></pre>
                    </div>
                </div>

                <!-- Warning Box -->
                <div class="info-box warning-box">
                    <div class="info-box-header">
                        <div class="info-box-icon">âš ï¸</div>
                        <div class="info-box-title">Warning: Auto-Isolation Considerations</div>
                    </div>
                    <ul>
                        <li><strong>Test thoroughly:</strong> Auto-isolation can disrupt business operationsâ€”test in non-production first</li>
                        <li><strong>Whitelist critical systems:</strong> Exclude domain controllers, critical servers from auto-isolation</li>
                        <li><strong>Approval workflows:</strong> Consider requiring human approval for production systems</li>
                        <li><strong>Audit logging:</strong> Log all automated actions for compliance and review</li>
                        <li><strong>Rollback procedures:</strong> Have documented steps to quickly un-isolate if needed</li>
                    </ul>
                </div>

                <!-- Interview Tips -->
                <div class="info-box interview-box">
                    <div class="info-box-header">
                        <div class="info-box-icon">ğŸ’¼</div>
                        <div class="info-box-title">Interview Tips</div>
                    </div>
                    <ul>
                        <li><strong>Common Question:</strong> "How would you automate EDR response without causing business disruption?"</li>
                        <li><strong>Strong Answer:</strong> Discuss tiered response based on threat category, whitelist critical systems, implement approval workflows for high-impact actions, and maintain comprehensive audit logs</li>
                        <li><strong>Key Points:</strong> Mention API authentication, rate limiting, error handling, and rollback procedures</li>
                        <li><strong>Bonus:</strong> Reference SOAR integration (XSOAR, Sentinel) for orchestrated response playbooks</li>
                    </ul>
                </div>

                <!-- Key Takeaways -->
                <h2>Key Takeaways</h2>
                <ul>
                    <li>EDR APIs enable powerful automation of detect, investigate, respond, and report workflows</li>
                    <li>Proper API authentication (OAuth2, API keys) is essential for security</li>
                    <li>Auto-isolation should be carefully scoped with whitelists and approval workflows</li>
                    <li>Integrate EDR automation with SIEM/SOAR for orchestrated response</li>
                    <li>Always implement comprehensive logging and error handling</li>
                    <li>Test automation thoroughly in non-production before deploying to production</li>
                </ul>

                <!-- Navigation -->
                <div class="page-navigation">
                    <a href="5-10-siem-integration.html" class="nav-button prev">
                        <span class="nav-button-label">Previous</span>
                        <span class="nav-button-title">â† 5.10 SIEM Integration</span>
                    </a>
                    <a href="5-12-compliance-automation.html" class="nav-button next">
                        <span class="nav-button-label">Next</span>
                        <span class="nav-button-title">5.12 Cloud Security Scripts â†’</span>
                    </a>
                </div>
            </div>
        </main>
    </div>

    <!-- Search Modal -->
    <div class="search-modal" id="searchModal">
        <div class="search-modal-content">
            <input type="text" class="search-modal-input" id="searchModalInput" placeholder="Search documentation..." autocomplete="off">
            <div class="search-modal-results" id="searchResults"></div>
        </div>
    </div>

    <!-- Mobile Toggle -->
    <button class="mobile-toggle">â˜°</button>

    <script src="main.js"></script>
</body>
</html>
